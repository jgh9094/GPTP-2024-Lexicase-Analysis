# clean start
rm(list = ls())
cat("\014")
setwd('/Users/hernandezj45/Desktop/Repositories/GPTP-2024-Lexicase-Analysis/')

# libraries we are using
library(ggplot2)
library(cowplot)
library(dplyr)
library(PupillometryR)
library(scales) # to access break formatting functions

# experiment variables

NAMES = c(50,100,500,1000,5000)
SHAPE <- c(25,21,22,23,24)
cb_palette <- c('#648FFF','#FE6100','#DC267F','#785EF0','#FFB000')
TSIZE <- 22

p_theme <- theme(
  plot.title = element_text( face = "bold", size = 22, hjust=0.5),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  legend.title=element_text(size=22),
  legend.text=element_text(size=23),
  axis.title = element_text(size=23),
  axis.text = element_text(size=19),
  legend.position="bottom",
  panel.background = element_rect(fill = "#f1f2f5",
                                  colour = "white",
                                  size = 0.5, linetype = "solid")
)

data_dir <- 'Paper_Data/Exploitation/'


# get over time data 
over_time <- read.csv(paste(data_dir, 'ot.csv', sep = "", collapse = NULL), header = TRUE, stringsAsFactors = FALSE)
over_time$pop_size <- factor(over_time$pop_size, levels = NAMES)

# aggregate 
lines = over_time %>%
  group_by(pop_size, eval) %>%
  dplyr::summarise(
    min = min(performance),
    mean = mean(performance),
    max = max(performance)
  )
lines$pop_size <- factor(lines$pop_size, levels = NAMES)

over_time_plot =  ggplot(lines, aes(x=eval, y=mean, group = pop_size, fill = pop_size, color = pop_size, shape = pop_size)) +
  geom_ribbon(aes(ymin = min, ymax = max), alpha = 0.1) +
  geom_line(size = 0.5) +
  geom_point(data = filter(lines, eval %% 100000000 == 0 & eval != 0), size = 1.0, stroke = 2.0, alpha = 1.0) +
  scale_y_continuous(
    name="Average trait score",
    limits=c(0, 100),
    breaks=seq(0,100, 25),
    labels=c("0", "25", "50", "75", "100")
  ) +
  scale_x_continuous(
    name="Evaluation",
    labels = c('0.0e+0', '5.0e+8','1.0e+9','1.5e+9'),
    limits = c(0,1520000000)
    
  ) +
  scale_shape_manual(values=SHAPE)+
  scale_colour_manual(values = cb_palette) +
  scale_fill_manual(values = cb_palette) +
  ggtitle('Performance over time')+
  p_theme +
  guides(
    shape=guide_legend(nrow=1, title.position = "left", title = 'Population Size'),
    color=guide_legend(nrow=1, title.position = "left", title = 'Population Size'),
    fill=guide_legend(nrow=1, title.position = "left", title = 'Population Size')
  )

# get best performance data 
best <- read.csv(paste(data_dir, 'best.csv', sep = "", collapse = NULL), header = TRUE, stringsAsFactors = FALSE)
best$pop_size <- factor(best$pop_size, levels = NAMES)

best_plot = ggplot(best, aes(x = pop_size, y = performance, color = pop_size, fill = pop_size, shape = pop_size)) +
  geom_flat_violin(position = position_nudge(x = .1, y = 0), scale = 'width', alpha = 0.2, width = 1.5) +
  geom_boxplot(color = 'black', width = .07, outlier.shape = NA, alpha = 0.0, size = 1.0, position = position_nudge(x = .16, y = 0)) +
  geom_point(position = position_jitter(width = 0.02, height = 0.0001), size = 1.5, alpha = 1.0) +
  scale_y_continuous(
    name="Average trait score",
    limits=c(0, 100),
    breaks=seq(0,100, 25),
    labels=c("0", "25", "50", "75", "100")
  ) +
  scale_x_discrete(
    name="Population Size"
  )+
  scale_shape_manual(values=SHAPE)+
  scale_colour_manual(values = cb_palette, ) +
  scale_fill_manual(values = cb_palette) +
  ggtitle('Best performance throughout')+
  p_theme +
  theme(# plot.title = element_text(hjust=0.5),
        axis.title.y.left = element_blank(),
        axis.title.y.right = element_blank(),
        axis.ticks.y.left = element_blank(),
        axis.text.y.left = element_blank(),
        axis.text.y.right = element_text(angle = 90, hjust = 0.5)
        )


# get the data
ssf <- read.csv(paste(data_dir, 'ssf.csv', sep = "", collapse = NULL), header = TRUE, stringsAsFactors = FALSE)
ssf$pop_size <- factor(ssf$pop_size, levels = NAMES)
ssf <- filter(ssf, evaluation <= 1.5*10^9)

# plot data 

ssf_plot = ggplot(ssf, aes(x = pop_size, y = evaluation, color = pop_size, fill = pop_size, shape = pop_size)) +
  geom_flat_violin(position = position_nudge(x = 0.12, y = 0), scale = 'width', alpha = 0.2, width = 1.5) +
  geom_boxplot(color = 'black', width = .08, outlier.shape = NA, alpha = 0.0, size = 0.8, position = position_nudge(x = .19, y = 0)) +
  geom_point(position = position_jitter(width = 0.03, height = 0.000001), size = 1.5, alpha = 1.0) +
  scale_y_continuous(
    name = 'Evaluation',
    breaks = c(100000000,500000000,1000000000,1500000000),
    labels = c('1.0e+8', '5.0e+8','1.0e+9','1.5e+9'),
    limits = c(100000000,1500000000)
    ) +
  scale_x_discrete(
    name="Population Size",
  )+
  scale_shape_manual(values=SHAPE, )+
  scale_colour_manual(values = cb_palette, ) +
  scale_fill_manual(values = cb_palette) +
  ggtitle(bquote('Evaluation Satisfactory Solution Found'))+
  p_theme + coord_flip()

top_row = plot_grid(
  over_time_plot + ggtitle("Performance over time") +
    theme(legend.position = "none", axis.title.y = element_text(angle = 90, hjust = 0.5), axis.text.y = element_text(angle = 90, hjust = 0.5)),
  best_plot + ggtitle("Best performance") +
    theme(legend.position = "none"),
  ncol=2,
  rel_widths = c(1.7,1.0),
  labels = c('      a',' b'),
  label_size = TSIZE
)

legend <- cowplot::get_legend(
  over_time_plot +
    guides(
      shape=guide_legend(nrow=1, title='Population size'),
      color=guide_legend(nrow=1, title='Population size'),
      fill=guide_legend(nrow=1, title='Population size')
    ) +
    theme(
      legend.position = "top",
      legend.box="verticle",
      legend.justification="center"
    )
)

fig = plot_grid(
  ggdraw() + draw_label("Results for Exploitation Rate Diagnositc", fontface='bold', size = 24) + p_theme,
  top_row,
  ssf_plot+ ggtitle("Evaluation satifactory solution found") +
    theme(legend.position = "none", axis.text.y = element_text(angle = 90, hjust = 0.5)),
  legend, 
  nrow = 4,
  rel_heights = c(0.21,1.6,1.5,.15),
  labels = c('','  ','      c'),
  label_size = TSIZE)

save_plot(
  filename ="exploitation.pdf",
  fig,
  base_width=13,
  base_height=7
)
